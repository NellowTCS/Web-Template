name: Build and Deploy to Updato CDN

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        working-directory: Build
        run: npm i

      - name: Build single file
        working-directory: Build
        run: npm run build:single

      - name: Generate version info
        id: version
        run: |
          VERSION=$(node -p "require('./Build/package.json').version")
          HASH=$(sha256sum Build/dist/index.html | awk '{print $1}')
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          NOTES="Automated build"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "hash=${HASH}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "notes=${NOTES}" >> $GITHUB_OUTPUT

      - name: Create version.json
        working-directory: Build/dist
        run: |
          cat > version.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "hash": "${{ steps.version.outputs.hash }}",
            "timestamp": "${{ steps.version.outputs.timestamp }}",
            "notes": "${{ steps.version.outputs.notes }}",
            "project": "Web-Template"
          }
          EOF

      - name: Rename for distribution
        working-directory: Build/dist
        run: mv index.html Web-Template.html

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Web-Template-Build
          path: |
            Build/dist/Web-Template.html
            Build/dist/version.json
          if-no-files-found: error

      - name: Dispatch to CDN
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repository: NellowTCS/updato-cdn
          event-type: new-build
          client-payload: |
            {
              "repo": "${{ github.repository }}",
              "artifact_name": "Web-Template-Build",
              "project_name": "Web-Template",
              "version": "${{ steps.version.outputs.version }}"
            }
